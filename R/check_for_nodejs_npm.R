#' Check if Node works
#'
#' @param node_top_dir directory containing nodejs app/exe
#'
#' @return path of nodejs executable if found and functional, otherwise: FALSE
.check_node_works <- function(node_top_dir) {
  
  message("Checking if the provided nodejs path already contains nodejs...")
  
  os <- shinybox::get_os()
  
  node_path <- normalizePath(node_top_dir,
                             "/",
                             mustWork = FALSE)
  
  if (os == "win") {
    
    node_path <- file.path(node_path,
                           "node.exe")
    
  } else {
    
    node_path <- file.path(node_path,
                           "node")    
  }
  
  node_exists <- file.exists(node_path)
  if (!node_exists)  stop("nodejs executable not found.")
  
  # Check that the node version is the same as what we expect and nodejs is functional
  
  quoted_node_path <- shQuote(node_path)
  command <- glue::glue("{quoted_node_path} -v")
  
  nodejs_response <- tryCatch(system(command, intern = TRUE),
                              error = function(e) FALSE, 
                              warning = function(e) FALSE)
  
  if (nodejs_response == FALSE)  stop(glue::glue("nodejs at {node_path} seems NOT to be functional."))
}







#' Check if npm works
#'
#' @param node_top_dir directory containing npmjs app/exe
#'
#' @return path of npm executable if found and functional, otherwise: FALSE
.check_npm_works <- function(node_top_dir) {
  
  message("Checking if given nodejs path already contains nodejs.")
  
  os <- shinybox::get_os()
  
  npm_path <- normalizePath(node_top_dir,
                            "/", 
                            mustWork = FALSE)
  
  npm_path <- file.path(npm_path, "npm")  
  
  npm_exists <- file.exists(npm_path)
  
  if (!npm_exists)  stop("npm seems not be installed.")
  
  
  # Check that the npm version is the same as what we expect
  
  quoted_npm_path <- shQuote(npm_path)
  
  command <- paste0(quoted_npm_path, 
                    " -v")
  
  result <- tryCatch(system(command, intern = TRUE),
                     error = function(e) FALSE, 
                     warning = function(e) FALSE)
  
  if(isFALSE(result)) { 
    
    stop(glue::glue("npm executable was found but seems not to be functional."))
    npm_path <- FALSE
    return(npm_path)
    
  } else  {
    message(glue::glue("Found npm at: {npm_path}"))
    return(npm_path)
  } 
}

